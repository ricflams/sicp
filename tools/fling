#!/bin/bash

# Config file to store the post ID and edit token
CONFIG_FILE="$HOME/.fling"

# Check if jq is installed, and install it if missing (only when using -i)
install_jq_if_needed() {
    if ! command -v jq &> /dev/null; then
        echo "jq is required but not installed. Installing now..."
        if [[ -f /etc/debian_version ]]; then
            sudo apt update && sudo apt install -y jq
        elif [[ -f /etc/redhat-release ]]; then
            sudo yum install -y jq
        elif [[ -f /etc/arch-release ]]; then
            sudo pacman -Sy jq
        else
            echo "Unsupported Linux distribution. Please install jq manually."
            exit 1
        fi
    fi
}

# Function to create a new post
create_post() {
    install_jq_if_needed  # Ensure jq is installed before proceeding
    TEXT="$1"
    RESPONSE=$(curl -s -X POST -d "content=$TEXT" https://write.as/api/posts)
    POST_ID=$(echo "$RESPONSE" | jq -r '.id')
    EDIT_TOKEN=$(echo "$RESPONSE" | jq -r '.token')
    POST_URL="https://write.as/$POST_ID"

    if [[ "$POST_ID" != "null" ]]; then
        echo "$POST_ID $EDIT_TOKEN" > "$CONFIG_FILE"
        echo "Post created: $POST_URL"
    else
        echo "Error creating post: $RESPONSE"
    fi
}

# Function to update an existing post
update_post() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo "No existing post found. Use -i to create one first!"
        exit 1
    fi

    POST_ID=$(awk '{print $1}' "$CONFIG_FILE")
    EDIT_TOKEN=$(awk '{print $2}' "$CONFIG_FILE")

    TEXT="$1"
    curl -s -X PUT -H "Authorization: Token $EDIT_TOKEN" --data-urlencode "content=$TEXT" "https://write.as/api/posts/$POST_ID"
    echo "Post updated: https://write.as/$POST_ID"
}

# Ensure correct usage
if [[ ! -f "$CONFIG_FILE" && "$1" != "-i" ]]; then
    echo "No existing post found. Use -i to create one first!"
    exit 1
fi

# Handle options
case "$1" in
    -i)
        shift
        create_post "$1"
        ;;
    -f)
        shift
        [[ -f "$1" ]] || { echo "File not found"; exit 1; }
        update_post "$(cat "$1")"
        ;;
    *)
        update_post "$1"
        ;;
esac
